<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Nijiiro</title>
        <style>
            * {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                box-sizing: border-box;
            }

            body {
                margin: 0;
                overflow: hidden;
                background: #000;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
            }
            canvas {
                display: block;
                width: 100vw;
                height: 100vh;
            }

            #brand {
                position: absolute;
                top: 24px;
                left: 30px;
                z-index: 100;
                pointer-events: none;
            }

            #brand h1 {
                margin: 0;
                font-size: 28px;
                font-weight: 800;
                letter-spacing: -1.5px;
                line-height: 1;
                background: linear-gradient(
                    135deg,
                    #fff 0%,
                    #a5a5a5 50%,
                    #fff 100%
                );
                background-size: 200% auto;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: shine 5s linear infinite;
            }

            #brand .tag {
                display: block;
                margin-top: 6px;
                font-size: 10px;
                font-weight: 500;
                letter-spacing: 3px;
                text-transform: uppercase;
                color: rgba(255, 255, 255, 0.3);
                pointer-events: auto;
                text-decoration: none;
                transition:
                    color 0.3s ease,
                    letter-spacing 0.3s ease;
            }

            #brand .tag:hover {
                color: #fff;
                letter-spacing: 4px;
            }
            @keyframes shine {
                to {
                    background-position: 200% center;
                }
            }

            #ui-toggle {
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 100;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #fff;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                font-size: 16px;
                line-height: 1;
            }
            #ui-toggle:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: scale(1.05);
            }

            #controls {
                position: absolute;
                top: 70px;
                right: 20px;
                width: 300px;
                background: rgba(15, 15, 20, 0.4);
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #eee;
                z-index: 90;
                box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: url(#liquid-filter);
                padding: 24px;
                max-height: 80vh;
                overflow-y: auto;
                scrollbar-gutter: stable;
                transition:
                    opacity 0.3s ease,
                    transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
                opacity: 1;
                transform: translateY(0) scale(1);
                transform-origin: top right;
                pointer-events: auto;
            }

            #controls.hidden {
                opacity: 0;
                transform: translateY(-10px) scale(0.9);
                pointer-events: none;
            }
            #controls::-webkit-scrollbar {
                width: 6px;
            }
            #controls::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 3px;
            }
            #controls::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 3px;
            }

            .control-group {
                margin-bottom: 20px;
            }
            .control-group:last-child {
                margin-bottom: 0;
            }

            label {
                display: block;
                font-size: 10px;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: rgba(255, 255, 255, 0.5);
                margin-bottom: 8px;
                font-weight: 600;
            }

            .slider-row {
                display: grid;
                grid-template-columns: 1fr 50px;
                gap: 12px;
                align-items: center;
            }

            input[type="range"] {
                width: 100%;
                -webkit-appearance: none;
                background: transparent;
            }
            input[type="range"]:focus {
                outline: none;
            }
            input[type="range"]::-webkit-slider-runnable-track {
                width: 100%;
                height: 4px;
                cursor: pointer;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 2px;
            }
            input[type="range"]::-webkit-slider-thumb {
                height: 12px;
                width: 12px;
                border-radius: 50%;
                background: #fff;
                cursor: pointer;
                -webkit-appearance: none;
                margin-top: -4px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
                transition: transform 0.1s;
            }
            input[type="range"]::-webkit-slider-thumb:hover {
                transform: scale(1.2);
            }

            input[type="number"] {
                width: 100%;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #fff;
                border-radius: 4px;
                font-family: inherit;
                font-size: 11px;
                padding: 4px;
                text-align: center;
                -moz-appearance: textfield;
                user-select: text !important;
                -webkit-user-select: text !important;
                transition:
                    border-color 0.2s,
                    background 0.2s;
            }
            input[type="number"]:focus {
                border-color: rgba(255, 255, 255, 0.4);
                outline: none;
                background: rgba(255, 255, 255, 0.1);
            }

            .toggle-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            .toggle-row label {
                margin: 0;
                cursor: pointer;
            }
            .switch {
                position: relative;
                display: inline-block;
                width: 32px;
                height: 18px;
            }
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255, 255, 255, 0.1);
                transition: 0.4s;
                border-radius: 18px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 12px;
                width: 12px;
                left: 2px;
                bottom: 2px;
                background-color: rgba(255, 255, 255, 0.5);
                transition: 0.4s;
                border-radius: 50%;
            }
            input:checked + .slider {
                background-color: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.4);
            }
            input:checked + .slider:before {
                transform: translateX(14px);
                background-color: #fff;
            }

            select {
                width: 100%;
                background: rgba(0, 0, 0, 0.3);
                color: #fff;
                border: 1px solid rgba(255, 255, 255, 0.15);
                padding: 10px;
                border-radius: 8px;
                font-family: inherit;
                font-size: 13px;
                cursor: pointer;
                outline: none;
                transition:
                    border-color 0.2s,
                    background 0.2s;
            }
            select:hover {
                border-color: rgba(255, 255, 255, 0.3);
                background: rgba(0, 0, 0, 0.5);
            }
            option {
                background: #111;
                color: #fff;
            }

            h3 {
                margin: 0 0 20px 0;
                font-size: 12px;
                letter-spacing: 3px;
                text-transform: uppercase;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 12px;
                color: rgba(255, 255, 255, 0.9);
            }

            .color-panel {
                display: none;
                background: rgba(255, 255, 255, 0.03);
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 16px;
                border: 1px solid rgba(255, 255, 255, 0.05);
                animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            #panel-grid-settings {
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                transition:
                    max-height 0.3s ease,
                    opacity 0.3s ease,
                    margin-top 0.3s ease;
                margin-top: 0;
            }
            #panel-grid-settings.visible {
                max-height: 150px;
                opacity: 1;
                margin-top: 12px;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .preview-bar {
                width: 100%;
                height: 8px;
                border-radius: 4px;
                margin-bottom: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: #000;
            }

            .stop-row {
                display: grid;
                grid-template-columns: 20px 1fr 45px 16px;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
            }
            .stop-color {
                -webkit-appearance: none;
                border: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                cursor: pointer;
                background: none;
                padding: 0;
                border: 2px solid rgba(255, 255, 255, 0.2);
                transition:
                    transform 0.2s,
                    border-color 0.2s;
            }
            .stop-color:hover {
                transform: scale(1.1);
                border-color: #fff;
            }
            .stop-color::-webkit-color-swatch-wrapper {
                padding: 0;
            }
            .stop-color::-webkit-color-swatch {
                border: none;
                border-radius: 50%;
            }
            .stop-remove {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.4);
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
                padding: 0;
                display: flex;
                justify-content: center;
                transition: color 0.2s;
            }
            .stop-remove:hover {
                color: #ff6b6b;
            }
            .stop-remove:disabled {
                color: rgba(255, 255, 255, 0.1);
                cursor: default;
            }

            #btn-add-stop {
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px dashed rgba(255, 255, 255, 0.15);
                color: rgba(255, 255, 255, 0.6);
                font-size: 10px;
                border-radius: 6px;
                cursor: pointer;
                text-transform: uppercase;
                letter-spacing: 1px;
                transition: all 0.2s;
            }
            #btn-add-stop:hover {
                background: rgba(255, 255, 255, 0.08);
                color: #fff;
                border-color: rgba(255, 255, 255, 0.3);
            }

            .button-group {
                display: flex;
                gap: 8px;
                margin-top: 24px;
            }
            .btn-action {
                flex: 1;
                padding: 10px 0;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.8);
                font-family: inherit;
                font-size: 10px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            .btn-action:hover {
                background: rgba(255, 255, 255, 0.15);
                color: #fff;
                border-color: rgba(255, 255, 255, 0.3);
            }
            #btn-share {
                background: rgba(50, 100, 255, 0.1);
                border-color: rgba(50, 100, 255, 0.2);
                color: #8ab4ff;
            }
            #btn-share:hover {
                background: rgba(50, 100, 255, 0.25);
                border-color: rgba(50, 100, 255, 0.4);
                color: #fff;
            }

            .color-picker-large {
                width: 100%;
                height: 36px;
                -webkit-appearance: none;
                border: none;
                background: none;
                cursor: pointer;
                border-radius: 6px;
                overflow: hidden;
                border: 1px solid rgba(255, 255, 255, 0.15);
                padding: 0;
                margin-bottom: 12px;
            }
            .color-picker-large::-webkit-color-swatch-wrapper {
                padding: 0;
            }
            .color-picker-large::-webkit-color-swatch {
                border: none;
            }
        </style>
    </head>
    <body>
        <canvas id="glcanvas"></canvas>

        <div id="brand">
            <h1>Nijiiro</h1>
            <a href="https://umaru.dev" target="_blank" class="tag"
                >umaru.dev</a
            >
        </div>

        <svg style="display: none">
            <defs>
                <filter
                    id="liquid-filter"
                    x="0%"
                    y="0%"
                    width="100%"
                    height="100%"
                >
                    <feImage id="liquid-map" result="map" />
                    <feDisplacementMap
                        in="SourceGraphic"
                        in2="map"
                        scale="25"
                        xChannelSelector="R"
                        yChannelSelector="G"
                    />
                    <feGaussianBlur stdDeviation="0.5" result="blur" />
                    <feComposite operator="in" in="blur" in2="SourceGraphic" />
                </filter>
            </defs>
        </svg>

        <button id="ui-toggle" title="Toggle Menu (H)">&times;</button>

        <div id="controls">
            <h3>Parameters</h3>

            <div class="control-group">
                <label>Color Theme</label>
                <select id="theme">
                    <option value="0">Neon</option>
                    <option value="6">Gold</option>
                    <option value="1">Magma</option>
                    <option value="2">Ocean</option>
                    <option value="3">Matrix</option>
                    <option value="4">Grayscale</option>
                    <option value="7">Custom Monochromatic</option>
                    <option value="5">Custom Gradient</option>
                </select>
            </div>

            <div id="panel-gradient" class="color-panel">
                <div id="gradient-preview" class="preview-bar"></div>
                <div id="stops-container"></div>
                <button id="btn-add-stop">+ Add Stop</button>
            </div>

            <div id="panel-mono" class="color-panel">
                <div id="mono-preview" class="preview-bar"></div>

                <label>Base Tint</label>
                <input
                    type="color"
                    id="cMono"
                    class="color-picker-large"
                    value="#ff8800"
                />

                <label>Balance (Midpoint)</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="monoPos"
                        min="0.01"
                        max="0.99"
                        step="0.01"
                        value="0.7"
                    />
                    <input
                        type="number"
                        id="num-monoPos"
                        min="0.01"
                        max="0.99"
                        step="0.01"
                        value="0.7"
                    />
                </div>
            </div>

            <div
                class="color-panel"
                style="display: block; padding-bottom: 4px"
            >
                <div class="toggle-row">
                    <label for="showGrid">Overlay Grid</label>
                    <label class="switch">
                        <input type="checkbox" id="showGrid" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="panel-grid-settings">
                    <div class="control-group">
                        <label>Density</label>
                        <div class="slider-row">
                            <input
                                type="range"
                                id="gridSize"
                                min="2.0"
                                max="50.0"
                                step="1.0"
                                value="10.0"
                            />
                            <input
                                type="number"
                                id="num-gridSize"
                                min="2.0"
                                max="50.0"
                                step="1.0"
                                value="10"
                            />
                        </div>
                    </div>
                    <div class="control-group" style="margin-bottom: 12px">
                        <label>Opacity</label>
                        <div class="slider-row">
                            <input
                                type="range"
                                id="gridAlpha"
                                min="0.0"
                                max="1.0"
                                step="0.05"
                                value="0.3"
                            />
                            <input
                                type="number"
                                id="num-gridAlpha"
                                min="0.0"
                                max="1.0"
                                step="0.05"
                                value="0.3"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Scale</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="scale"
                        min="0.5"
                        max="5.0"
                        step="0.1"
                        value="1.1"
                    />
                    <input
                        type="number"
                        id="num-scale"
                        min="0.5"
                        max="5.0"
                        step="0.1"
                        value="1.1"
                    />
                </div>
            </div>

            <div class="control-group">
                <label>Warp Strength</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="warp"
                        min="0.0"
                        max="2.0"
                        step="0.1"
                        value="0.6"
                    />
                    <input
                        type="number"
                        id="num-warp"
                        min="0.0"
                        max="2.0"
                        step="0.1"
                        value="0.6"
                    />
                </div>
            </div>

            <div class="control-group">
                <label>Speed</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="speed"
                        min="0.0"
                        max="1.0"
                        step="0.01"
                        value="0.2"
                    />
                    <input
                        type="number"
                        id="num-speed"
                        min="0.0"
                        max="1.0"
                        step="0.01"
                        value="0.2"
                    />
                </div>
            </div>

            <div class="control-group">
                <label>Line Thickness</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="thickness"
                        min="0.1"
                        max="2.5"
                        step="0.1"
                        value="0.9"
                    />
                    <input
                        type="number"
                        id="num-thickness"
                        min="0.1"
                        max="2.5"
                        step="0.1"
                        value="0.9"
                    />
                </div>
            </div>

            <div class="control-group">
                <label>Brightness</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="brightness"
                        min="0.5"
                        max="5.0"
                        step="0.1"
                        value="3.0"
                    />
                    <input
                        type="number"
                        id="num-brightness"
                        min="0.5"
                        max="5.0"
                        step="0.1"
                        value="3.0"
                    />
                </div>
            </div>

            <div class="control-group">
                <label>Grain</label>
                <div class="slider-row">
                    <input
                        type="range"
                        id="grain"
                        min="0.0"
                        max="0.2"
                        step="0.01"
                        value="0.05"
                    />
                    <input
                        type="number"
                        id="num-grain"
                        min="0.0"
                        max="0.2"
                        step="0.01"
                        value="0.05"
                    />
                </div>
            </div>

            <div class="button-group">
                <button id="btn-share" class="btn-action">Share</button>
                <button id="btn-reset" class="btn-action">Reset</button>
            </div>
        </div>

        <script>
            function hexToRgb(hex) {
                const bigint = parseInt(hex.slice(1), 16);
                const r = ((bigint >> 16) & 255) / 255;
                const g = ((bigint >> 8) & 255) / 255;
                const b = (bigint & 255) / 255;
                return [r, g, b];
            }

            function updateLiquidGlass() {
                const el = document.getElementById("controls");
                const rect = el.getBoundingClientRect();
                const w = rect.width;
                const h = rect.height;
                const bezel = 20;

                const canvas = document.createElement("canvas");
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext("2d");

                ctx.fillStyle = "rgb(128, 128, 0)";
                ctx.fillRect(0, 0, w, h);

                const gradL = ctx.createLinearGradient(0, 0, bezel, 0);
                gradL.addColorStop(0, "rgb(180, 128, 0)");
                gradL.addColorStop(1, "rgb(128, 128, 0)");
                ctx.fillStyle = gradL;
                ctx.fillRect(0, 0, bezel, h);

                const gradR = ctx.createLinearGradient(w - bezel, 0, w, 0);
                gradR.addColorStop(0, "rgb(128, 128, 0)");
                gradR.addColorStop(1, "rgb(76, 128, 0)");
                ctx.fillStyle = gradR;
                ctx.fillRect(w - bezel, 0, bezel, h);

                const gradT = ctx.createLinearGradient(0, 0, 0, bezel);
                gradT.addColorStop(0, "rgb(128, 180, 0)");
                gradT.addColorStop(1, "rgb(128, 128, 0)");
                ctx.fillStyle = gradT;
                ctx.fillRect(0, 0, w, bezel);

                const gradB = ctx.createLinearGradient(0, h - bezel, 0, h);
                gradB.addColorStop(0, "rgb(128, 128, 0)");
                gradB.addColorStop(1, "rgb(128, 76, 0)");
                ctx.fillStyle = gradB;
                ctx.fillRect(0, h - bezel, w, bezel);

                const dataUrl = canvas.toDataURL();
                const feImage = document.getElementById("liquid-map");
                if (feImage) feImage.setAttribute("href", dataUrl);
            }

            const MAX_STOPS = 8;
            const defaultStops = [
                { pos: 0.0, color: "#220033" },
                { pos: 0.33, color: "#aa0055" },
                { pos: 0.66, color: "#00ccff" },
                { pos: 1.0, color: "#ffffff" },
            ];

            const defaults = {
                theme: 0,
                scale: 1.1,
                warp: 0.6,
                speed: 0.2,
                thickness: 0.9,
                brightness: 3.0,
                grain: 0.05,
                cMono: "#ff8800",
                monoPos: 0.7,
                showGrid: false,
                gridSize: 10.0,
                gridAlpha: 0.3,
            };

            let params = { ...defaults };
            let customStops = JSON.parse(JSON.stringify(defaultStops));
            let uiVisible = true;

            const SNAP_POINTS = [0.0, 0.25, 0.33, 0.5, 0.66, 0.75, 1.0];
            const SNAP_THRESHOLD = 0.03;

            function getSnappedValue(val) {
                for (let point of SNAP_POINTS) {
                    if (Math.abs(val - point) < SNAP_THRESHOLD) return point;
                }
                return val;
            }

            const stopsContainer = document.getElementById("stops-container");
            const gradientPreview = document.getElementById("gradient-preview");
            const monoPreview = document.getElementById("mono-preview");
            const btnAddStop = document.getElementById("btn-add-stop");
            const themeSelect = document.getElementById("theme");
            const panelGrad = document.getElementById("panel-gradient");
            const panelMono = document.getElementById("panel-mono");
            const panelGridSettings = document.getElementById(
                "panel-grid-settings",
            );
            const controlsDiv = document.getElementById("controls");
            const toggleBtn = document.getElementById("ui-toggle");

            function updateURL() {
                const state = { p: params, s: customStops };
                try {
                    const hash = btoa(JSON.stringify(state));
                    window.history.replaceState(null, null, "#" + hash);
                } catch (e) {}
            }

            function loadFromURL() {
                if (window.location.hash && window.location.hash.length > 1) {
                    try {
                        const raw = window.location.hash.substring(1);
                        const state = JSON.parse(atob(raw));
                        if (state.p) params = { ...params, ...state.p };
                        if (state.s) customStops = state.s;

                        Object.keys(params).forEach((key) => {
                            const el = document.getElementById(key);
                            const numEl = document.getElementById(`num-${key}`);

                            if (el) {
                                if (el.type === "checkbox") {
                                    el.checked = params[key];
                                } else {
                                    el.value = params[key];
                                    if (numEl) numEl.value = params[key];
                                }
                            }
                        });
                        themeSelect.value = params.theme;
                        updatePanels();
                        renderStopsUI();
                        updateMonoPreview();
                    } catch (e) {}
                }
            }

            function updateGradientPreview() {
                const sorted = [...customStops].sort((a, b) => a.pos - b.pos);
                const gradientStr = sorted
                    .map((s) => `${s.color} ${s.pos * 100}%`)
                    .join(", ");
                gradientPreview.style.background = `linear-gradient(90deg, ${gradientStr})`;
            }

            function updateMonoPreview() {
                if (monoPreview) {
                    const pos = params.monoPos * 100;
                    monoPreview.style.background = `linear-gradient(90deg, #000 0%, ${params.cMono} ${pos}%, #fff 100%)`;
                }
            }

            function renderStopsUI() {
                stopsContainer.innerHTML = "";
                customStops.forEach((stop, index) => {
                    const row = document.createElement("div");
                    row.className = "stop-row";

                    const picker = document.createElement("input");
                    picker.type = "color";
                    picker.className = "stop-color";
                    picker.value = stop.color;
                    picker.oninput = (e) => {
                        stop.color = e.target.value;
                        updateGradientPreview();
                        updateURL();
                    };

                    const slider = document.createElement("input");
                    slider.type = "range";
                    slider.min = 0;
                    slider.max = 1;
                    slider.step = 0.001;
                    slider.value = stop.pos;

                    const numInput = document.createElement("input");
                    numInput.type = "number";
                    numInput.className = "stop-input";
                    numInput.min = 0;
                    numInput.max = 1;
                    numInput.step = 0.01;
                    numInput.value = stop.pos.toFixed(2);

                    slider.oninput = (e) => {
                        let val = parseFloat(e.target.value);
                        val = getSnappedValue(val);
                        slider.value = val;
                        stop.pos = val;
                        numInput.value = val.toFixed(2);
                        updateGradientPreview();
                        updateURL();
                    };

                    numInput.onchange = (e) => {
                        let val = parseFloat(e.target.value);
                        if (isNaN(val)) val = 0;
                        val = Math.max(0, Math.min(1, val));
                        stop.pos = val;
                        slider.value = val;
                        updateGradientPreview();
                        updateURL();
                    };

                    const btnRemove = document.createElement("button");
                    btnRemove.className = "stop-remove";
                    btnRemove.innerHTML = "&times;";
                    if (customStops.length <= 2) btnRemove.disabled = true;
                    btnRemove.onclick = () => {
                        if (customStops.length > 2) {
                            customStops.splice(index, 1);
                            renderStopsUI();
                            updateURL();
                        }
                    };

                    row.appendChild(picker);
                    row.appendChild(slider);
                    row.appendChild(numInput);
                    row.appendChild(btnRemove);
                    stopsContainer.appendChild(row);
                });

                btnAddStop.disabled = customStops.length >= MAX_STOPS;
                btnAddStop.innerText =
                    customStops.length >= MAX_STOPS
                        ? "Max Stops Reached"
                        : "+ Add Stop";
                updateGradientPreview();
            }

            btnAddStop.onclick = () => {
                if (customStops.length < MAX_STOPS) {
                    const last = customStops[customStops.length - 1];
                    const newPos = Math.max(0, Math.min(1, last.pos - 0.1));
                    customStops.push({ pos: newPos, color: "#888888" });
                    renderStopsUI();
                    updateURL();
                }
            };

            function updateParam(key, value) {
                if (key === "showGrid") {
                    params[key] = value === "true" || value === true;
                    if (params[key]) panelGridSettings.classList.add("visible");
                    else panelGridSettings.classList.remove("visible");
                } else {
                    params[key] = parseFloat(value);

                    const slider = document.getElementById(key);
                    const num = document.getElementById(`num-${key}`);
                    if (slider) slider.value = params[key];
                    if (num) num.value = params[key];

                    if (key === "monoPos") updateMonoPreview();
                }
                updateURL();
            }

            [
                "scale",
                "warp",
                "speed",
                "thickness",
                "brightness",
                "grain",
                "gridSize",
                "gridAlpha",
                "monoPos",
            ].forEach((key) => {
                const slider = document.getElementById(key);
                const num = document.getElementById(`num-${key}`);

                if (slider)
                    slider.addEventListener("input", (e) =>
                        updateParam(key, e.target.value),
                    );
                if (num)
                    num.addEventListener("input", (e) =>
                        updateParam(key, e.target.value),
                    );
            });

            const gridCheck = document.getElementById("showGrid");
            if (gridCheck) {
                gridCheck.addEventListener("change", (e) =>
                    updateParam("showGrid", e.target.checked),
                );
            }

            document.getElementById("cMono").addEventListener("input", (e) => {
                params.cMono = e.target.value;
                updateMonoPreview();
                updateURL();
            });

            function updatePanels() {
                panelGrad.style.display = params.theme === 5 ? "block" : "none";
                panelMono.style.display = params.theme === 7 ? "block" : "none";

                if (params.showGrid) panelGridSettings.classList.add("visible");
                else panelGridSettings.classList.remove("visible");
            }

            themeSelect.addEventListener("change", (e) => {
                params.theme = parseInt(e.target.value);
                updatePanels();
                updateURL();
            });

            function toggleUI() {
                uiVisible = !uiVisible;
                if (uiVisible) {
                    controlsDiv.classList.remove("hidden");
                    toggleBtn.innerHTML = "&times;";
                } else {
                    controlsDiv.classList.add("hidden");
                    toggleBtn.innerHTML = "&#9776;";
                }
            }
            toggleBtn.addEventListener("click", toggleUI);
            window.addEventListener("keydown", (e) => {
                if (e.key.toLowerCase() === "h") toggleUI();
            });

            const btnShare = document.getElementById("btn-share");
            btnShare.addEventListener("click", () => {
                updateURL();
                navigator.clipboard.writeText(window.location.href).then(() => {
                    const origText = btnShare.innerText;
                    btnShare.innerText = "Copied!";
                    btnShare.style.background = "rgba(46, 204, 113, 0.5)";
                    btnShare.style.borderColor = "rgba(46, 204, 113, 0.8)";
                    btnShare.style.color = "#fff";
                    setTimeout(() => {
                        btnShare.innerText = origText;
                        btnShare.style.background = "";
                        btnShare.style.borderColor = "";
                        btnShare.style.color = "";
                    }, 1500);
                });
            });

            document
                .getElementById("btn-reset")
                .addEventListener("click", () => {
                    Object.keys(defaults).forEach((key) => {
                        params[key] = defaults[key];
                        const el = document.getElementById(key);
                        const num = document.getElementById(`num-${key}`);
                        if (el) {
                            if (el.type === "checkbox")
                                el.checked = defaults[key];
                            else el.value = defaults[key];
                        }
                        if (num) num.value = defaults[key];
                    });
                    customStops = JSON.parse(JSON.stringify(defaultStops));
                    renderStopsUI();
                    updatePanels();
                    updateMonoPreview();
                    window.history.replaceState(null, null, " ");
                });

            loadFromURL();
            if (!window.location.hash) renderStopsUI();
            updatePanels();
            updateMonoPreview();
            updateLiquidGlass();

            const resizeObserver = new ResizeObserver(() => {
                requestAnimationFrame(updateLiquidGlass);
            });
            resizeObserver.observe(controlsDiv);

            const vsSource = `#version 300 es
    in vec4 position;
    void main() { gl_Position = position; }`;

            const fsSource = `#version 300 es
    precision highp float;
    #define MAX_STOPS 8
    uniform vec2 u_resolution; uniform float u_time;
    uniform int u_theme; uniform float u_scale; uniform float u_warp;
    uniform float u_thickness; uniform float u_brightness; uniform float u_grain;
    uniform vec3 u_mono; uniform float u_monoPos;

    uniform float u_showGrid;
    uniform float u_gridSize;
    uniform float u_gridAlpha;

    uniform int u_stopCount; uniform vec3 u_stopColors[MAX_STOPS]; uniform float u_stopPos[MAX_STOPS];
    out vec4 outColor;

    vec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }
    float snoise(vec2 v){
      const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
      vec2 i  = floor(v + dot(v, C.yy) );
      vec2 x0 = v -   i + dot(i, C.xx);
      vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
      vec4 x12 = x0.xyxy + C.xxzz;
      x12.xy -= i1;
      i = mod(i, 289.0);
      vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 )) + i.x + vec3(0.0, i1.x, 1.0 ));
      vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
      m = m*m ; m = m*m ;
      vec3 x = 2.0 * fract(p * C.www) - 1.0;
      vec3 h = abs(x) - 0.5;
      vec3 ox = floor(x + 0.5);
      vec3 a0 = x - ox;
      m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );
      vec3 g;
      g.x  = a0.x  * x0.x  + h.x  * x0.y;
      g.yz = a0.yz * x12.xz + h.yz * x12.yw;
      return 130.0 * dot(m, g);
    }

    float grid(vec2 uv, float size) {
        vec2 gridUV = uv * size;
        vec2 gridLine = step(1.0 - fwidth(gridUV) * 1.0, fract(gridUV));
        return max(gridLine.x, gridLine.y);
    }

    vec3 paletteNeon(float t) {
        t = fract(t);
        vec3 c0 = vec3(255, 50, 120)/255.0; vec3 c1 = vec3(255, 30, 180)/255.0;
        vec3 c2 = vec3(180, 50, 255)/255.0; vec3 c3 = vec3(100, 80, 255)/255.0;
        vec3 c4 = vec3(50, 180, 255)/255.0; vec3 c5 = vec3(50, 230, 220)/255.0;
        vec3 c6 = vec3(80, 255, 150)/255.0; vec3 c7 = vec3(180, 255, 80)/255.0;
        vec3 c8 = vec3(255, 220, 50)/255.0;
        if(t<0.12) return mix(c0,c1,t/0.12); if(t<0.25) return mix(c1,c2,(t-0.12)/0.13);
        if(t<0.38) return mix(c2,c3,(t-0.25)/0.13); if(t<0.50) return mix(c3,c4,(t-0.38)/0.12);
        if(t<0.62) return mix(c4,c5,(t-0.50)/0.12); if(t<0.75) return mix(c5,c6,(t-0.62)/0.13);
        if(t<0.88) return mix(c6,c7,(t-0.75)/0.13); return mix(c7,c8,(t-0.88)/0.12);
    }
    vec3 paletteMagma(float t) {
        t = fract(t);
        vec3 c0 = vec3(0.1, 0.0, 0.0); vec3 c1 = vec3(0.5, 0.0, 0.0);
        vec3 c2 = vec3(1.0, 0.0, 0.0); vec3 c3 = vec3(1.0, 0.5, 0.0);
        vec3 c4 = vec3(1.0, 1.0, 0.0); vec3 c5 = vec3(1.0, 1.0, 0.8);
        if(t<0.2) return mix(c0,c1,t/0.2); if(t<0.4) return mix(c1,c2,(t-0.2)/0.2);
        if(t<0.6) return mix(c2,c3,(t-0.4)/0.2); if(t<0.8) return mix(c3,c4,(t-0.6)/0.2);
        return mix(c4,c5,(t-0.8)/0.2);
    }
    vec3 paletteOcean(float t) {
        t = fract(t);
        vec3 c0 = vec3(0.0, 0.05, 0.2); vec3 c1 = vec3(0.0, 0.2, 0.6);
        vec3 c2 = vec3(0.0, 0.6, 0.8); vec3 c3 = vec3(0.0, 0.9, 0.9);
        vec3 c4 = vec3(0.8, 1.0, 1.0);
        if(t<0.25) return mix(c0,c1,t/0.25); if(t<0.50) return mix(c1,c2,(t-0.25)/0.25);
        if(t<0.75) return mix(c2,c3,(t-0.50)/0.25); return mix(c3,c4,(t-0.75)/0.25);
    }
    vec3 paletteMatrix(float t) {
        t = fract(t);
        vec3 c0 = vec3(0.0, 0.1, 0.0); vec3 c1 = vec3(0.0, 0.6, 0.1);
        vec3 c2 = vec3(0.4, 0.9, 0.4); vec3 c3 = vec3(0.8, 1.0, 0.8);
        if(t<0.33) return mix(c0,c1,t/0.33); if(t<0.66) return mix(c1,c2,(t-0.33)/0.33);
        return mix(c2,c3,(t-0.66)/0.34);
    }
    vec3 paletteMono(float t) { return vec3(smoothstep(0.0, 1.0, fract(t))); }

    vec3 paletteGold(float t) {
        t = fract(t);
        vec3 c0 = vec3(0.15, 0.08, 0.0); vec3 c1 = vec3(0.4, 0.25, 0.05);
        vec3 c2 = vec3(0.8, 0.6, 0.2);   vec3 c3 = vec3(1.0, 0.9, 0.5);
        vec3 c4 = vec3(1.0, 1.0, 0.9);
        if(t<0.25) return mix(c0,c1,t/0.25); if(t<0.50) return mix(c1,c2,(t-0.25)/0.25);
        if(t<0.75) return mix(c2,c3,(t-0.50)/0.25); return mix(c3,c4,(t-0.75)/0.25);
    }
    vec3 paletteCustomMono(float t) {
        t = fract(t);
        float p = u_monoPos;
        if(p < 0.01) p = 0.01; if(p > 0.99) p = 0.99;

        if(t < p) return mix(vec3(0.0), u_mono, t/p);
        return mix(u_mono, vec3(1.0), (t-p)/(1.0-p));
    }

    vec3 paletteCustomDynamic(float t) {
        t = fract(t);
        if (t <= u_stopPos[0]) return u_stopColors[0];
        if (t >= u_stopPos[u_stopCount-1]) return u_stopColors[u_stopCount-1];
        for (int i = 0; i < MAX_STOPS - 1; i++) {
            if (i >= u_stopCount - 1) break;
            float pA = u_stopPos[i]; float pB = u_stopPos[i+1];
            if (t >= pA && t < pB) {
                float range = max(pB - pA, 0.0001);
                return mix(u_stopColors[i], u_stopColors[i+1], (t - pA) / range);
            }
        }
        return u_stopColors[u_stopCount-1];
    }

    vec3 getPalette(float t, int theme) {
        if (theme == 1) return paletteMagma(t);
        if (theme == 2) return paletteOcean(t);
        if (theme == 3) return paletteMatrix(t);
        if (theme == 4) return paletteMono(t);
        if (theme == 5) return paletteCustomDynamic(t);
        if (theme == 6) return paletteGold(t);
        if (theme == 7) return paletteCustomMono(t);
        return paletteNeon(t);
    }

    vec3 renderBackground(vec2 uv, int theme) {
        vec3 deep, glow;
        if (theme == 1) { deep = vec3(0.03, 0.0, 0.0); glow = vec3(0.08, 0.02, 0.0); }
        else if (theme == 2) { deep = vec3(0.0, 0.01, 0.04); glow = vec3(0.0, 0.04, 0.08); }
        else if (theme == 3) { deep = vec3(0.0, 0.03, 0.0); glow = vec3(0.0, 0.08, 0.0); }
        else if (theme == 4) { deep = vec3(0.01); glow = vec3(0.05); }
        else if (theme == 5) { deep = u_stopColors[0] * 0.1; glow = u_stopColors[1] * 0.2; }
        else if (theme == 6) { deep = vec3(0.05, 0.03, 0.0); glow = vec3(0.12, 0.08, 0.02); }
        else if (theme == 7) { deep = u_mono * 0.1; glow = u_mono * 0.25; }
        else { deep = vec3(0.01, 0.005, 0.03); glow = vec3(0.06, 0.02, 0.08); }

        float n1 = snoise(uv * 0.4 + vec2(u_time * 0.01, u_time * 0.005));
        float n2 = snoise(uv * 0.8 - vec2(u_time * 0.015));
        float fog = smoothstep(0.0, 1.0, n1 * 0.6 + n2 * 0.4);
        float dist = length(uv - 0.5);
        float radial = 1.0 - smoothstep(0.2, 1.2, dist);
        return mix(deep, glow, fog * radial * 0.6);
    }

    vec3 renderScene(vec2 uv, vec2 offsetScale) {
        float warpTime = u_time * 0.05;
        vec2 warpUV = uv * u_warp;
        float q = snoise(warpUV + vec2(warpTime, warpTime));
        float r = snoise(warpUV + vec2(q + warpTime, q + warpTime));
        vec2 distortedUV = uv + vec2(q, r) * 0.1;
        distortedUV += offsetScale;
        float h = snoise(distortedUV * u_scale + u_time * 0.04);
        h = h * 0.5 + 0.5;
        float fadeN = snoise(uv * u_warp - u_time * 0.05);
        fadeN = smoothstep(0.35, 0.65, fadeN * 0.5 + 0.5);
        float levels = 16.0;
        float dist = abs(fract(h * levels) - 0.5);
        float fw = fwidth(dist);
        float line = smoothstep(u_thickness * fw, (u_thickness - 1.5) * fw, dist);
        float hueShift = u_time * 0.05;
        float effectiveHue = (u_theme >= 3) ? 0.0 : hueShift;
        vec3 color = getPalette(h + effectiveHue, u_theme);
        return color * line * fadeN * u_brightness;
    }

    void main() {
        vec2 uv = gl_FragCoord.xy / u_resolution.xy;
        uv.x *= u_resolution.x / u_resolution.y;

        vec3 bg = renderBackground(gl_FragCoord.xy / u_resolution.xy, u_theme);

        if (u_showGrid > 0.5) {
            float g = grid(uv, u_gridSize);
            bg = mix(bg, vec3(1.0), g * u_gridAlpha);
        }

        float chrAmount = 0.003 + sin(u_time * 0.3) * 0.001;
        float r = renderScene(uv, vec2(chrAmount, 0.0)).r;
        float g = renderScene(uv, vec2(0.0, 0.0)).g;
        float b = renderScene(uv, vec2(-chrAmount, 0.0)).b;
        vec3 lines = vec3(r, g, b);
        vec3 finalColor = bg + lines;
        vec2 vUv = gl_FragCoord.xy / u_resolution.xy;
        float dist = distance(vUv, vec2(0.5));
        float vignette = smoothstep(1.2, 0.2, dist);
        finalColor *= vignette;
        float grain = fract(sin(dot(uv + mod(u_time, 10.0), vec2(12.9898,78.233))) * 43758.5453123) * u_grain;
        outColor = vec4(finalColor + grain, 1.0);
    }`;

            const canvas = document.getElementById("glcanvas");
            const gl = canvas.getContext("webgl2", {
                antialias: false,
                alpha: false,
            });
            if (!gl) document.body.innerHTML = "WebGL 2 not supported";

            function createShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source.trim());
                gl.compileShader(shader);
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS))
                    return null;
                return shader;
            }

            const program = gl.createProgram();
            gl.attachShader(
                program,
                createShader(gl, gl.VERTEX_SHADER, vsSource),
            );
            gl.attachShader(
                program,
                createShader(gl, gl.FRAGMENT_SHADER, fsSource),
            );
            gl.linkProgram(program);

            const positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(
                gl.ARRAY_BUFFER,
                new Float32Array([-1, 1, 1, 1, -1, -1, 1, -1]),
                gl.STATIC_DRAW,
            );
            gl.enableVertexAttribArray(
                gl.getAttribLocation(program, "position"),
            );
            gl.vertexAttribPointer(
                gl.getAttribLocation(program, "position"),
                2,
                gl.FLOAT,
                false,
                0,
                0,
            );

            const uLocs = {
                res: gl.getUniformLocation(program, "u_resolution"),
                time: gl.getUniformLocation(program, "u_time"),
                theme: gl.getUniformLocation(program, "u_theme"),
                scale: gl.getUniformLocation(program, "u_scale"),
                warp: gl.getUniformLocation(program, "u_warp"),
                thick: gl.getUniformLocation(program, "u_thickness"),
                bright: gl.getUniformLocation(program, "u_brightness"),
                grain: gl.getUniformLocation(program, "u_grain"),
                mono: gl.getUniformLocation(program, "u_mono"),
                monoPos: gl.getUniformLocation(program, "u_monoPos"),
                showGrid: gl.getUniformLocation(program, "u_showGrid"),
                gridSize: gl.getUniformLocation(program, "u_gridSize"),
                gridAlpha: gl.getUniformLocation(program, "u_gridAlpha"),
                stopCount: gl.getUniformLocation(program, "u_stopCount"),
                stopColors: gl.getUniformLocation(program, "u_stopColors"),
                stopPos: gl.getUniformLocation(program, "u_stopPos"),
            };

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
            window.addEventListener("resize", resize);
            resize();

            let timeAccumulator = 0;
            let lastTime = performance.now();

            function render(currentTime) {
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;
                timeAccumulator += deltaTime * params.speed;

                gl.useProgram(program);
                gl.uniform2f(uLocs.res, canvas.width, canvas.height);
                gl.uniform1f(uLocs.time, timeAccumulator * 0.001);
                gl.uniform1i(uLocs.theme, params.theme);
                gl.uniform1f(uLocs.scale, params.scale);
                gl.uniform1f(uLocs.warp, params.warp);
                gl.uniform1f(uLocs.thick, params.thickness);
                gl.uniform1f(uLocs.bright, params.brightness);
                gl.uniform1f(uLocs.grain, params.grain);
                gl.uniform3fv(uLocs.mono, hexToRgb(params.cMono));
                gl.uniform1f(uLocs.monoPos, params.monoPos);

                gl.uniform1f(uLocs.showGrid, params.showGrid ? 1.0 : 0.0);
                gl.uniform1f(uLocs.gridSize, params.gridSize);
                gl.uniform1f(uLocs.gridAlpha, params.gridAlpha);

                const sortedStops = [...customStops].sort(
                    (a, b) => a.pos - b.pos,
                );
                const flatColors = [];
                const flatPos = [];
                sortedStops.forEach((s) => {
                    flatColors.push(...hexToRgb(s.color));
                    flatPos.push(s.pos);
                });
                gl.uniform1i(uLocs.stopCount, sortedStops.length);
                gl.uniform3fv(uLocs.stopColors, new Float32Array(flatColors));
                gl.uniform1fv(uLocs.stopPos, new Float32Array(flatPos));

                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                requestAnimationFrame(render);
            }
            requestAnimationFrame(render);
        </script>
    </body>
</html>
